!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";var a,i=(function(t,e){var r,p,s,a,i,n=(r={},p=Math.PI/180,s=180/Math.PI,a=6378137,i=20037508.342789244,o.prototype.px=function(t,e){if(u(e)){var a=this.size*Math.pow(2,e),i=a/2,r=a/360,n=a/(2*Math.PI),o=a,s=Math.min(Math.max(Math.sin(p*t[1]),-.9999),.9999);return o<(h=i+t[0]*r)&&(h=o),o<(c=i+.5*Math.log((1+s)/(1-s))*-n)&&(c=o),[h,c]}i=this.zc[e],s=Math.min(Math.max(Math.sin(p*t[1]),-.9999),.9999);var h=Math.round(i+t[0]*this.Bc[e]),c=Math.round(i+.5*Math.log((1+s)/(1-s))*-this.Cc[e]);return h>this.Ac[e]&&(h=this.Ac[e]),c>this.Ac[e]&&(c=this.Ac[e]),[h,c]},o.prototype.ll=function(t,e){if(u(e)){var a=this.size*Math.pow(2,e),i=a/360,r=a/(2*Math.PI),n=a/2,o=(t[1]-n)/-r;return[(t[0]-n)/i,s*(2*Math.atan(Math.exp(o))-.5*Math.PI)]}return o=(t[1]-this.zc[e])/-this.Cc[e],[(t[0]-this.zc[e])/this.Bc[e],s*(2*Math.atan(Math.exp(o))-.5*Math.PI)]},o.prototype.bbox=function(t,e,a,i,r){i&&(e=Math.pow(2,a)-1-e);var n=[t*this.size,(+e+1)*this.size],o=[(+t+1)*this.size,e*this.size],s=this.ll(n,a).concat(this.ll(o,a));return"900913"===r?this.convert(s,"900913"):s},o.prototype.xyz=function(t,e,a,i){"900913"===i&&(t=this.convert(t,"WGS84"));var r=[t[0],t[1]],n=[t[2],t[3]],o=this.px(r,e),s=this.px(n,e),h=[Math.floor(o[0]/this.size),Math.floor((s[0]-1)/this.size)],c=[Math.floor(s[1]/this.size),Math.floor((o[1]-1)/this.size)],p={minX:Math.min.apply(Math,h)<0?0:Math.min.apply(Math,h),minY:Math.min.apply(Math,c)<0?0:Math.min.apply(Math,c),maxX:Math.max.apply(Math,h),maxY:Math.max.apply(Math,c)};if(a){var u={minY:Math.pow(2,e)-1-p.maxY,maxY:Math.pow(2,e)-1-p.minY};p.minY=u.minY,p.maxY=u.maxY}return p},o.prototype.convert=function(t,e){return"900913"===e?this.forward(t.slice(0,2)).concat(this.forward(t.slice(2,4))):this.inverse(t.slice(0,2)).concat(this.inverse(t.slice(2,4)))},o.prototype.forward=function(t){var e=[a*t[0]*p,a*Math.log(Math.tan(.25*Math.PI+.5*t[1]*p))];return e[0]>i&&(e[0]=i),e[0]<-i&&(e[0]=-i),e[1]>i&&(e[1]=i),e[1]<-i&&(e[1]=-i),e},o.prototype.inverse=function(t){return[t[0]*s/a,(.5*Math.PI-2*Math.atan(Math.exp(-t[1]/a)))*s]},o);function u(t){return Number(t)===t&&t%1!=0}function o(t){if(t=t||{},this.size=t.size||256,!r[this.size]){var e=this.size,a=r[this.size]={};a.Bc=[],a.Cc=[],a.zc=[],a.Ac=[];for(var i=0;i<30;i++)a.Bc.push(e/360),a.Cc.push(e/(2*Math.PI)),a.zc.push(e/2),a.Ac.push(e),e*=2}this.Bc=r[this.size].Bc,this.Cc=r[this.size].Cc,this.zc=r[this.size].zc,this.Ac=r[this.size].Ac}t.exports=n}(a={exports:{}},a.exports),a.exports),r=function(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t};function n(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var o=new i({size:256});function s(t){t.renderer.loadTileImage=function(t,e){var a=new Image;a.onload=function(){t.src=e},a.src=e}}var h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,e.TileLayer),r(c,[{key:"_initBUffer",value:function(t){var e=this;this.on("renderercreate",s);var a=t.dbUrl;this._databaseIsLoaded=!1,"string"==typeof a?fetch(a).then(function(t){return t.arrayBuffer()}).then(function(t){e._openDB(t)}).catch(function(t){e.fire("databaseerror",{error:t})}):a instanceof ArrayBuffer?this._openDB(a):this.fire("databaseerror")}},{key:"_openDB",value:function(t){try{this._db=new window.SQL.Database(new Uint8Array(t)),this._stmt=this._db.prepare("SELECT tile_data FROM tiles WHERE zoom_level = :z AND tile_column = :x AND tile_row = :y");var e=this._db.prepare("SELECT value FROM metadata WHERE name = :key"),a=void 0;(a=e.getAsObject({":key":"attribution"})).value&&(this.options.attribution=a.value),(a=e.getAsObject({":key":"minzoom"})).value&&(this.options.minZoom=Number(a.value)),(a=e.getAsObject({":key":"maxzoom"})).value&&(this.options.maxZoom=Number(a.value)),(a=e.getAsObject({":key":"format"})).value&&"png"===a.value?this._format="image/png":a.value&&"jpg"===a.value?this._format="image/jpg":this._format="image/png",this.fire("databaseloaded"),this._databaseIsLoaded=!0,this.load()}catch(t){this.fire("databaseerror",{error:t})}}},{key:"getTileUrl",value:function(t,e,a){if(this._stmt){var i=function(t){return o.xyz([-180,-85.05112877980659,180,85.0511287798066],t)}(this.map.getZoom());i&&i.maxY&&(e=i.maxY-e);var r=this._stmt.getAsObject({":x":t,":y":e,":z":a});return"tile_data"in r?window.URL.createObjectURL(new Blob([r.tile_data],{type:"image/png"})):void 0}}}]),c);function c(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c);var a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,t,e));return a._initBUffer(e),a}t.MBTileLayer=h,Object.defineProperty(t,"__esModule",{value:!0})});
