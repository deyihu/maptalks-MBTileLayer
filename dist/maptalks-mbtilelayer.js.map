{"version":3,"file":"maptalks-mbtilelayer.js","sources":["../node_modules/@mapbox/sphericalmercator/sphericalmercator.js","../src/MBTileLayer.js"],"sourcesContent":["var SphericalMercator = (function(){\n\n// Closures including constants and other precalculated values.\nvar cache = {},\n    EPSLN = 1.0e-10,\n    D2R = Math.PI / 180,\n    R2D = 180 / Math.PI,\n    // 900913 properties.\n    A = 6378137.0,\n    MAXEXTENT = 20037508.342789244;\n\nfunction isFloat(n){\n    return Number(n) === n && n % 1 !== 0;\n}\n\n// SphericalMercator constructor: precaches calculations\n// for fast tile lookups.\nfunction SphericalMercator(options) {\n    options = options || {};\n    this.size = options.size || 256;\n    if (!cache[this.size]) {\n        var size = this.size;\n        var c = cache[this.size] = {};\n        c.Bc = [];\n        c.Cc = [];\n        c.zc = [];\n        c.Ac = [];\n        for (var d = 0; d < 30; d++) {\n            c.Bc.push(size / 360);\n            c.Cc.push(size / (2 * Math.PI));\n            c.zc.push(size / 2);\n            c.Ac.push(size);\n            size *= 2;\n        }\n    }\n    this.Bc = cache[this.size].Bc;\n    this.Cc = cache[this.size].Cc;\n    this.zc = cache[this.size].zc;\n    this.Ac = cache[this.size].Ac;\n};\n\n// Convert lon lat to screen pixel value\n//\n// - `ll` {Array} `[lon, lat]` array of geographic coordinates.\n// - `zoom` {Number} zoom level.\nSphericalMercator.prototype.px = function(ll, zoom) {\n  if (isFloat(zoom)) {\n    var size = this.size * Math.pow(2, zoom);\n    var d = size / 2;\n    var bc = (size / 360);\n    var cc = (size / (2 * Math.PI));\n    var ac = size;\n    var f = Math.min(Math.max(Math.sin(D2R * ll[1]), -0.9999), 0.9999);\n    var x = d + ll[0] * bc;\n    var y = d + 0.5 * Math.log((1 + f) / (1 - f)) * -cc;\n    (x > ac) && (x = ac);\n    (y > ac) && (y = ac);\n    //(x < 0) && (x = 0);\n    //(y < 0) && (y = 0);\n    return [x, y];\n  } else {\n    var d = this.zc[zoom];\n    var f = Math.min(Math.max(Math.sin(D2R * ll[1]), -0.9999), 0.9999);\n    var x = Math.round(d + ll[0] * this.Bc[zoom]);\n    var y = Math.round(d + 0.5 * Math.log((1 + f) / (1 - f)) * (-this.Cc[zoom]));\n    (x > this.Ac[zoom]) && (x = this.Ac[zoom]);\n    (y > this.Ac[zoom]) && (y = this.Ac[zoom]);\n    //(x < 0) && (x = 0);\n    //(y < 0) && (y = 0);\n    return [x, y];\n  }\n};\n\n// Convert screen pixel value to lon lat\n//\n// - `px` {Array} `[x, y]` array of geographic coordinates.\n// - `zoom` {Number} zoom level.\nSphericalMercator.prototype.ll = function(px, zoom) {\n  if (isFloat(zoom)) {\n    var size = this.size * Math.pow(2, zoom);\n    var bc = (size / 360);\n    var cc = (size / (2 * Math.PI));\n    var zc = size / 2;\n    var g = (px[1] - zc) / -cc;\n    var lon = (px[0] - zc) / bc;\n    var lat = R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);\n    return [lon, lat];\n  } else {\n    var g = (px[1] - this.zc[zoom]) / (-this.Cc[zoom]);\n    var lon = (px[0] - this.zc[zoom]) / this.Bc[zoom];\n    var lat = R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);\n    return [lon, lat];\n  }\n};\n\n// Convert tile xyz value to bbox of the form `[w, s, e, n]`\n//\n// - `x` {Number} x (longitude) number.\n// - `y` {Number} y (latitude) number.\n// - `zoom` {Number} zoom.\n// - `tms_style` {Boolean} whether to compute using tms-style.\n// - `srs` {String} projection for resulting bbox (WGS84|900913).\n// - `return` {Array} bbox array of values in form `[w, s, e, n]`.\nSphericalMercator.prototype.bbox = function(x, y, zoom, tms_style, srs) {\n    // Convert xyz into bbox with srs WGS84\n    if (tms_style) {\n        y = (Math.pow(2, zoom) - 1) - y;\n    }\n    // Use +y to make sure it's a number to avoid inadvertent concatenation.\n    var ll = [x * this.size, (+y + 1) * this.size]; // lower left\n    // Use +x to make sure it's a number to avoid inadvertent concatenation.\n    var ur = [(+x + 1) * this.size, y * this.size]; // upper right\n    var bbox = this.ll(ll, zoom).concat(this.ll(ur, zoom));\n\n    // If web mercator requested reproject to 900913.\n    if (srs === '900913') {\n        return this.convert(bbox, '900913');\n    } else {\n        return bbox;\n    }\n};\n\n// Convert bbox to xyx bounds\n//\n// - `bbox` {Number} bbox in the form `[w, s, e, n]`.\n// - `zoom` {Number} zoom.\n// - `tms_style` {Boolean} whether to compute using tms-style.\n// - `srs` {String} projection of input bbox (WGS84|900913).\n// - `@return` {Object} XYZ bounds containing minX, maxX, minY, maxY properties.\nSphericalMercator.prototype.xyz = function(bbox, zoom, tms_style, srs) {\n    // If web mercator provided reproject to WGS84.\n    if (srs === '900913') {\n        bbox = this.convert(bbox, 'WGS84');\n    }\n\n    var ll = [bbox[0], bbox[1]]; // lower left\n    var ur = [bbox[2], bbox[3]]; // upper right\n    var px_ll = this.px(ll, zoom);\n    var px_ur = this.px(ur, zoom);\n    // Y = 0 for XYZ is the top hence minY uses px_ur[1].\n    var x = [ Math.floor(px_ll[0] / this.size), Math.floor((px_ur[0] - 1) / this.size) ];\n    var y = [ Math.floor(px_ur[1] / this.size), Math.floor((px_ll[1] - 1) / this.size) ];\n    var bounds = {\n        minX: Math.min.apply(Math, x) < 0 ? 0 : Math.min.apply(Math, x),\n        minY: Math.min.apply(Math, y) < 0 ? 0 : Math.min.apply(Math, y),\n        maxX: Math.max.apply(Math, x),\n        maxY: Math.max.apply(Math, y)\n    };\n    if (tms_style) {\n        var tms = {\n            minY: (Math.pow(2, zoom) - 1) - bounds.maxY,\n            maxY: (Math.pow(2, zoom) - 1) - bounds.minY\n        };\n        bounds.minY = tms.minY;\n        bounds.maxY = tms.maxY;\n    }\n    return bounds;\n};\n\n// Convert projection of given bbox.\n//\n// - `bbox` {Number} bbox in the form `[w, s, e, n]`.\n// - `to` {String} projection of output bbox (WGS84|900913). Input bbox\n//   assumed to be the \"other\" projection.\n// - `@return` {Object} bbox with reprojected coordinates.\nSphericalMercator.prototype.convert = function(bbox, to) {\n    if (to === '900913') {\n        return this.forward(bbox.slice(0, 2)).concat(this.forward(bbox.slice(2,4)));\n    } else {\n        return this.inverse(bbox.slice(0, 2)).concat(this.inverse(bbox.slice(2,4)));\n    }\n};\n\n// Convert lon/lat values to 900913 x/y.\nSphericalMercator.prototype.forward = function(ll) {\n    var xy = [\n        A * ll[0] * D2R,\n        A * Math.log(Math.tan((Math.PI*0.25) + (0.5 * ll[1] * D2R)))\n    ];\n    // if xy value is beyond maxextent (e.g. poles), return maxextent.\n    (xy[0] > MAXEXTENT) && (xy[0] = MAXEXTENT);\n    (xy[0] < -MAXEXTENT) && (xy[0] = -MAXEXTENT);\n    (xy[1] > MAXEXTENT) && (xy[1] = MAXEXTENT);\n    (xy[1] < -MAXEXTENT) && (xy[1] = -MAXEXTENT);\n    return xy;\n};\n\n// Convert 900913 x/y values to lon/lat.\nSphericalMercator.prototype.inverse = function(xy) {\n    return [\n        (xy[0] * R2D / A),\n        ((Math.PI*0.5) - 2.0 * Math.atan(Math.exp(-xy[1] / A))) * R2D\n    ];\n};\n\nreturn SphericalMercator;\n\n})();\n\nif (typeof module !== 'undefined' && typeof exports !== 'undefined') {\n    module.exports = exports = SphericalMercator;\n}\n","import { TileLayer } from 'maptalks';\r\n// var SphericalMercator = require('@mapbox/sphericalmercator');\r\nimport SphericalMercator from '@mapbox/sphericalmercator';\r\n\r\nconst merc = new SphericalMercator({\r\n\tsize: 256\r\n});\r\n\r\nfunction renderercreateCallback(e) {\r\n\te.renderer.loadTileImage = function (img, url) {\r\n\t\tconst remoteImage = new Image();\r\n\t\tremoteImage.onload = function () {\r\n\t\t\timg.src = url;\r\n\t\t};\r\n\t\tremoteImage.src = url;\r\n\t};\r\n}\r\n\r\nfunction calTileRange(zoom) {\r\n\treturn merc.xyz([-180, -85.05112877980659, 180, 85.0511287798066], zoom);\r\n}\r\n\r\nclass MBTileLayer extends TileLayer {\r\n\tconstructor(id, options) {\r\n\t\tsuper(id, options);\r\n\t\tthis._initBUffer(options);\r\n\r\n\t}\r\n\r\n\t_initBUffer(options) {\r\n\t\tthis.on('renderercreate', renderercreateCallback);\r\n\t\tconst databaseUrl = options.dbUrl;\r\n\t\tthis._databaseIsLoaded = false;\r\n\t\tif (typeof databaseUrl === 'string') {\r\n\t\t\tfetch(databaseUrl).then(response => {\r\n\t\t\t\treturn response.arrayBuffer();\r\n\t\t\t}).then(buffer => {\r\n\t\t\t\tthis._openDB(buffer);\r\n\t\t\t}).catch(err => {\r\n\t\t\t\tthis.fire('databaseerror', { error: err });\r\n\t\t\t});\r\n\t\t} else if (databaseUrl instanceof ArrayBuffer) {\r\n\t\t\tthis._openDB(databaseUrl);\r\n\t\t} else {\r\n\t\t\tthis.fire('databaseerror');\r\n\t\t}\r\n\r\n\t}\r\n\r\n    /**\r\n     *  copy from https://gitlab.com/IvanSanchez/Leaflet.TileLayer.MBTiles\r\n     * @param {*} buffer\r\n     */\r\n\t_openDB(buffer) {\r\n\t\ttry {\r\n\t\t\t/// This assumes the `SQL` global variable to exist!!\r\n\t\t\tthis._db = new window.SQL.Database(new Uint8Array(buffer));\r\n\t\t\tthis._stmt = this._db.prepare('SELECT tile_data FROM tiles WHERE zoom_level = :z AND tile_column = :x AND tile_row = :y');\r\n\r\n\t\t\t// Load some metadata (or at least try to)\r\n\t\t\tconst metaStmt = this._db.prepare('SELECT value FROM metadata WHERE name = :key');\r\n\t\t\tlet row;\r\n\r\n\t\t\trow = metaStmt.getAsObject({ ':key': 'attribution' });\r\n\t\t\tif (row.value) { this.options.attribution = row.value; }\r\n\r\n\t\t\trow = metaStmt.getAsObject({ ':key': 'minzoom' });\r\n\t\t\tif (row.value) { this.options.minZoom = Number(row.value); }\r\n\r\n\t\t\trow = metaStmt.getAsObject({ ':key': 'maxzoom' });\r\n\t\t\tif (row.value) { this.options.maxZoom = Number(row.value); }\r\n\r\n\t\t\trow = metaStmt.getAsObject({ ':key': 'format' });\r\n\t\t\tif (row.value && row.value === 'png') {\r\n\t\t\t\tthis._format = 'image/png';\r\n\t\t\t} else if (row.value && row.value === 'jpg') {\r\n\t\t\t\tthis._format = 'image/jpg';\r\n\t\t\t} else {\r\n\t\t\t\t// Fall back to PNG, hope it works.\r\n\t\t\t\tthis._format = 'image/png';\r\n\t\t\t}\r\n\r\n\t\t\t// üçÇevent databaseloaded\r\n\t\t\t// Fired when the database has been loaded, parsed, and ready for queries\r\n\t\t\tthis.fire('databaseloaded');\r\n\t\t\tthis._databaseIsLoaded = true;\r\n\t\t\tthis.load();\r\n\r\n\t\t} catch (ex) {\r\n\t\t\t// üçÇevent databaseloaded\r\n\t\t\t// Fired when the database could not load for any reason. Might contain\r\n\t\t\t// an `error` property describing the error.\r\n\t\t\tthis.fire('databaseerror', { error: ex });\r\n\t\t}\r\n\t}\r\n\r\n\tgetTileUrl(x, y, z) {\r\n\t\tif (!this._stmt) return undefined;\r\n\t\tconst tileRange = calTileRange(this.map.getZoom());\r\n\t\tif (tileRange && tileRange.maxY) y = tileRange.maxY - y;\r\n\t\tconst row = this._stmt.getAsObject({\r\n\t\t\t':x': x,\r\n\t\t\t':y': y,\r\n\t\t\t':z': z\r\n\t\t});\r\n\t\tif ('tile_data' in row) {\r\n\t\t\treturn window.URL.createObjectURL(new Blob([row.tile_data], { type: 'image/png' }));\r\n\t\t} else {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default MBTileLayer;"],"names":["SphericalMercator","cache","EPSLN","D2R","Math","PI","R2D","A","MAXEXTENT","isFloat","n","Number","options","size","c","Bc","Cc","zc","Ac","d","push","prototype","px","ll","zoom","pow","bc","cc","ac","f","min","max","sin","x","y","log","round","g","lon","lat","atan","exp","bbox","tms_style","srs","ur","concat","convert","xyz","px_ll","px_ur","floor","bounds","minX","apply","minY","maxX","maxY","tms","to","forward","slice","inverse","xy","tan","module","exports","merc","renderercreateCallback","e","renderer","loadTileImage","img","url","remoteImage","Image","onload","src","calTileRange","MBTileLayer","id","_initBUffer","on","databaseUrl","dbUrl","_databaseIsLoaded","fetch","then","response","arrayBuffer","_openDB","buffer","catch","fire","error","err","ArrayBuffer","_db","window","SQL","Database","Uint8Array","_stmt","prepare","metaStmt","row","getAsObject","value","attribution","minZoom","maxZoom","_format","load","ex","z","undefined","tileRange","map","getZoom","URL","createObjectURL","Blob","tile_data","type","TileLayer"],"mappings":";;;;;;;;;;;;;;;;;CAAA,QAAIA,oBAAqB,YAAU;;;CAGnC,YAAIC,QAAQ,EAAZ;CAAA,YACIC,AACAC,MAAMC,KAAKC,EAAL,GAAU,GAFpB;CAAA,YAGIC,MAAM,MAAMF,KAAKC,EAHrB;;;CAKIE,YAAI,SALR;CAAA,YAMIC,YAAY,kBANhB;;CAQA,iBAASC,OAAT,CAAiBC,CAAjB,EAAmB;CACf,mBAAOC,OAAOD,CAAP,MAAcA,CAAd,IAAmBA,IAAI,CAAJ,KAAU,CAApC;CACH;;;;CAID,iBAASV,iBAAT,CAA2BY,OAA3B,EAAoC;CAChCA,sBAAUA,WAAW,EAArB;CACA,iBAAKC,IAAL,GAAYD,QAAQC,IAAR,IAAgB,GAA5B;CACA,gBAAI,CAACZ,MAAM,KAAKY,IAAX,CAAL,EAAuB;CACnB,oBAAIA,OAAO,KAAKA,IAAhB;CACA,oBAAIC,IAAIb,MAAM,KAAKY,IAAX,IAAmB,EAA3B;CACAC,kBAAEC,EAAF,GAAO,EAAP;CACAD,kBAAEE,EAAF,GAAO,EAAP;CACAF,kBAAEG,EAAF,GAAO,EAAP;CACAH,kBAAEI,EAAF,GAAO,EAAP;CACA,qBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,EAApB,EAAwBA,GAAxB,EAA6B;CACzBL,sBAAEC,EAAF,CAAKK,IAAL,CAAUP,OAAO,GAAjB;CACAC,sBAAEE,EAAF,CAAKI,IAAL,CAAUP,QAAQ,IAAIT,KAAKC,EAAjB,CAAV;CACAS,sBAAEG,EAAF,CAAKG,IAAL,CAAUP,OAAO,CAAjB;CACAC,sBAAEI,EAAF,CAAKE,IAAL,CAAUP,IAAV;CACAA,4BAAQ,CAAR;CACH;CACJ;CACD,iBAAKE,EAAL,GAAUd,MAAM,KAAKY,IAAX,EAAiBE,EAA3B;CACA,iBAAKC,EAAL,GAAUf,MAAM,KAAKY,IAAX,EAAiBG,EAA3B;CACA,iBAAKC,EAAL,GAAUhB,MAAM,KAAKY,IAAX,EAAiBI,EAA3B;CACA,iBAAKC,EAAL,GAAUjB,MAAM,KAAKY,IAAX,EAAiBK,EAA3B;CACH;;;;;CAMDlB,0BAAkBqB,SAAlB,CAA4BC,EAA5B,GAAiC,UAASC,EAAT,EAAaC,IAAb,EAAmB;CAClD,gBAAIf,QAAQe,IAAR,CAAJ,EAAmB;CACjB,oBAAIX,OAAO,KAAKA,IAAL,GAAYT,KAAKqB,GAAL,CAAS,CAAT,EAAYD,IAAZ,CAAvB;CACA,oBAAIL,IAAIN,OAAO,CAAf;CACA,oBAAIa,KAAMb,OAAO,GAAjB;CACA,oBAAIc,KAAMd,QAAQ,IAAIT,KAAKC,EAAjB,CAAV;CACA,oBAAIuB,KAAKf,IAAT;CACA,oBAAIgB,IAAIzB,KAAK0B,GAAL,CAAS1B,KAAK2B,GAAL,CAAS3B,KAAK4B,GAAL,CAAS7B,MAAMoB,GAAG,CAAH,CAAf,CAAT,EAAgC,CAAC,MAAjC,CAAT,EAAmD,MAAnD,CAAR;CACA,oBAAIU,IAAId,IAAII,GAAG,CAAH,IAAQG,EAApB;CACA,oBAAIQ,IAAIf,IAAI,MAAMf,KAAK+B,GAAL,CAAS,CAAC,IAAIN,CAAL,KAAW,IAAIA,CAAf,CAAT,CAAN,GAAoC,CAACF,EAAjD;CACCM,oBAAIL,EAAL,KAAaK,IAAIL,EAAjB;CACCM,oBAAIN,EAAL,KAAaM,IAAIN,EAAjB;;;CAGA,uBAAO,CAACK,CAAD,EAAIC,CAAJ,CAAP;CACD,aAdD,MAcO;CACL,oBAAIf,IAAI,KAAKF,EAAL,CAAQO,IAAR,CAAR;CACA,oBAAIK,IAAIzB,KAAK0B,GAAL,CAAS1B,KAAK2B,GAAL,CAAS3B,KAAK4B,GAAL,CAAS7B,MAAMoB,GAAG,CAAH,CAAf,CAAT,EAAgC,CAAC,MAAjC,CAAT,EAAmD,MAAnD,CAAR;CACA,oBAAIU,IAAI7B,KAAKgC,KAAL,CAAWjB,IAAII,GAAG,CAAH,IAAQ,KAAKR,EAAL,CAAQS,IAAR,CAAvB,CAAR;CACA,oBAAIU,IAAI9B,KAAKgC,KAAL,CAAWjB,IAAI,MAAMf,KAAK+B,GAAL,CAAS,CAAC,IAAIN,CAAL,KAAW,IAAIA,CAAf,CAAT,CAAN,GAAqC,CAAC,KAAKb,EAAL,CAAQQ,IAAR,CAArD,CAAR;CACCS,oBAAI,KAAKf,EAAL,CAAQM,IAAR,CAAL,KAAwBS,IAAI,KAAKf,EAAL,CAAQM,IAAR,CAA5B;CACCU,oBAAI,KAAKhB,EAAL,CAAQM,IAAR,CAAL,KAAwBU,IAAI,KAAKhB,EAAL,CAAQM,IAAR,CAA5B;;;CAGA,uBAAO,CAACS,CAAD,EAAIC,CAAJ,CAAP;CACD;CACF,SA1BD;;;;;;CAgCAlC,0BAAkBqB,SAAlB,CAA4BE,EAA5B,GAAiC,UAASD,EAAT,EAAaE,IAAb,EAAmB;CAClD,gBAAIf,QAAQe,IAAR,CAAJ,EAAmB;CACjB,oBAAIX,OAAO,KAAKA,IAAL,GAAYT,KAAKqB,GAAL,CAAS,CAAT,EAAYD,IAAZ,CAAvB;CACA,oBAAIE,KAAMb,OAAO,GAAjB;CACA,oBAAIc,KAAMd,QAAQ,IAAIT,KAAKC,EAAjB,CAAV;CACA,oBAAIY,KAAKJ,OAAO,CAAhB;CACA,oBAAIwB,IAAI,CAACf,GAAG,CAAH,IAAQL,EAAT,IAAe,CAACU,EAAxB;CACA,oBAAIW,MAAM,CAAChB,GAAG,CAAH,IAAQL,EAAT,IAAeS,EAAzB;CACA,oBAAIa,MAAMjC,OAAO,IAAIF,KAAKoC,IAAL,CAAUpC,KAAKqC,GAAL,CAASJ,CAAT,CAAV,CAAJ,GAA6B,MAAMjC,KAAKC,EAA/C,CAAV;CACA,uBAAO,CAACiC,GAAD,EAAMC,GAAN,CAAP;CACD,aATD,MASO;CACL,oBAAIF,IAAI,CAACf,GAAG,CAAH,IAAQ,KAAKL,EAAL,CAAQO,IAAR,CAAT,IAA2B,CAAC,KAAKR,EAAL,CAAQQ,IAAR,CAApC;CACA,oBAAIc,MAAM,CAAChB,GAAG,CAAH,IAAQ,KAAKL,EAAL,CAAQO,IAAR,CAAT,IAA0B,KAAKT,EAAL,CAAQS,IAAR,CAApC;CACA,oBAAIe,MAAMjC,OAAO,IAAIF,KAAKoC,IAAL,CAAUpC,KAAKqC,GAAL,CAASJ,CAAT,CAAV,CAAJ,GAA6B,MAAMjC,KAAKC,EAA/C,CAAV;CACA,uBAAO,CAACiC,GAAD,EAAMC,GAAN,CAAP;CACD;CACF,SAhBD;;;;;;;;;;CA0BAvC,0BAAkBqB,SAAlB,CAA4BqB,IAA5B,GAAmC,UAAST,CAAT,EAAYC,CAAZ,EAAeV,IAAf,EAAqBmB,SAArB,EAAgCC,GAAhC,EAAqC;;CAEpE,gBAAID,SAAJ,EAAe;CACXT,oBAAK9B,KAAKqB,GAAL,CAAS,CAAT,EAAYD,IAAZ,IAAoB,CAArB,GAA0BU,CAA9B;CACH;;CAED,gBAAIX,KAAK,CAACU,IAAI,KAAKpB,IAAV,EAAgB,CAAC,CAACqB,CAAD,GAAK,CAAN,IAAW,KAAKrB,IAAhC,CAAT,CANoE;;CAQpE,gBAAIgC,KAAK,CAAC,CAAC,CAACZ,CAAD,GAAK,CAAN,IAAW,KAAKpB,IAAjB,EAAuBqB,IAAI,KAAKrB,IAAhC,CAAT,CARoE;CASpE,gBAAI6B,OAAO,KAAKnB,EAAL,CAAQA,EAAR,EAAYC,IAAZ,EAAkBsB,MAAlB,CAAyB,KAAKvB,EAAL,CAAQsB,EAAR,EAAYrB,IAAZ,CAAzB,CAAX;;;CAGA,gBAAIoB,QAAQ,QAAZ,EAAsB;CAClB,uBAAO,KAAKG,OAAL,CAAaL,IAAb,EAAmB,QAAnB,CAAP;CACH,aAFD,MAEO;CACH,uBAAOA,IAAP;CACH;CACJ,SAjBD;;;;;;;;;CA0BA1C,0BAAkBqB,SAAlB,CAA4B2B,GAA5B,GAAkC,UAASN,IAAT,EAAelB,IAAf,EAAqBmB,SAArB,EAAgCC,GAAhC,EAAqC;;CAEnE,gBAAIA,QAAQ,QAAZ,EAAsB;CAClBF,uBAAO,KAAKK,OAAL,CAAaL,IAAb,EAAmB,OAAnB,CAAP;CACH;;CAED,gBAAInB,KAAK,CAACmB,KAAK,CAAL,CAAD,EAAUA,KAAK,CAAL,CAAV,CAAT,CANmE;CAOnE,gBAAIG,KAAK,CAACH,KAAK,CAAL,CAAD,EAAUA,KAAK,CAAL,CAAV,CAAT,CAPmE;CAQnE,gBAAIO,QAAQ,KAAK3B,EAAL,CAAQC,EAAR,EAAYC,IAAZ,CAAZ;CACA,gBAAI0B,QAAQ,KAAK5B,EAAL,CAAQuB,EAAR,EAAYrB,IAAZ,CAAZ;;CAEA,gBAAIS,IAAI,CAAE7B,KAAK+C,KAAL,CAAWF,MAAM,CAAN,IAAW,KAAKpC,IAA3B,CAAF,EAAoCT,KAAK+C,KAAL,CAAW,CAACD,MAAM,CAAN,IAAW,CAAZ,IAAiB,KAAKrC,IAAjC,CAApC,CAAR;CACA,gBAAIqB,IAAI,CAAE9B,KAAK+C,KAAL,CAAWD,MAAM,CAAN,IAAW,KAAKrC,IAA3B,CAAF,EAAoCT,KAAK+C,KAAL,CAAW,CAACF,MAAM,CAAN,IAAW,CAAZ,IAAiB,KAAKpC,IAAjC,CAApC,CAAR;CACA,gBAAIuC,SAAS;CACTC,sBAAMjD,KAAK0B,GAAL,CAASwB,KAAT,CAAelD,IAAf,EAAqB6B,CAArB,IAA0B,CAA1B,GAA8B,CAA9B,GAAkC7B,KAAK0B,GAAL,CAASwB,KAAT,CAAelD,IAAf,EAAqB6B,CAArB,CAD/B;CAETsB,sBAAMnD,KAAK0B,GAAL,CAASwB,KAAT,CAAelD,IAAf,EAAqB8B,CAArB,IAA0B,CAA1B,GAA8B,CAA9B,GAAkC9B,KAAK0B,GAAL,CAASwB,KAAT,CAAelD,IAAf,EAAqB8B,CAArB,CAF/B;CAGTsB,sBAAMpD,KAAK2B,GAAL,CAASuB,KAAT,CAAelD,IAAf,EAAqB6B,CAArB,CAHG;CAITwB,sBAAMrD,KAAK2B,GAAL,CAASuB,KAAT,CAAelD,IAAf,EAAqB8B,CAArB;CAJG,aAAb;CAMA,gBAAIS,SAAJ,EAAe;CACX,oBAAIe,MAAM;CACNH,0BAAOnD,KAAKqB,GAAL,CAAS,CAAT,EAAYD,IAAZ,IAAoB,CAArB,GAA0B4B,OAAOK,IADjC;CAENA,0BAAOrD,KAAKqB,GAAL,CAAS,CAAT,EAAYD,IAAZ,IAAoB,CAArB,GAA0B4B,OAAOG;CAFjC,iBAAV;CAIAH,uBAAOG,IAAP,GAAcG,IAAIH,IAAlB;CACAH,uBAAOK,IAAP,GAAcC,IAAID,IAAlB;CACH;CACD,mBAAOL,MAAP;CACH,SA5BD;;;;;;;;CAoCApD,0BAAkBqB,SAAlB,CAA4B0B,OAA5B,GAAsC,UAASL,IAAT,EAAeiB,EAAf,EAAmB;CACrD,gBAAIA,OAAO,QAAX,EAAqB;CACjB,uBAAO,KAAKC,OAAL,CAAalB,KAAKmB,KAAL,CAAW,CAAX,EAAc,CAAd,CAAb,EAA+Bf,MAA/B,CAAsC,KAAKc,OAAL,CAAalB,KAAKmB,KAAL,CAAW,CAAX,EAAa,CAAb,CAAb,CAAtC,CAAP;CACH,aAFD,MAEO;CACH,uBAAO,KAAKC,OAAL,CAAapB,KAAKmB,KAAL,CAAW,CAAX,EAAc,CAAd,CAAb,EAA+Bf,MAA/B,CAAsC,KAAKgB,OAAL,CAAapB,KAAKmB,KAAL,CAAW,CAAX,EAAa,CAAb,CAAb,CAAtC,CAAP;CACH;CACJ,SAND;;;CASA7D,0BAAkBqB,SAAlB,CAA4BuC,OAA5B,GAAsC,UAASrC,EAAT,EAAa;CAC/C,gBAAIwC,KAAK,CACLxD,IAAIgB,GAAG,CAAH,CAAJ,GAAYpB,GADP,EAELI,IAAIH,KAAK+B,GAAL,CAAS/B,KAAK4D,GAAL,CAAU5D,KAAKC,EAAL,GAAQ,IAAT,GAAkB,MAAMkB,GAAG,CAAH,CAAN,GAAcpB,GAAzC,CAAT,CAFC,CAAT;;CAKC4D,eAAG,CAAH,IAAQvD,SAAT,KAAwBuD,GAAG,CAAH,IAAQvD,SAAhC;CACCuD,eAAG,CAAH,IAAQ,CAACvD,SAAV,KAAyBuD,GAAG,CAAH,IAAQ,CAACvD,SAAlC;CACCuD,eAAG,CAAH,IAAQvD,SAAT,KAAwBuD,GAAG,CAAH,IAAQvD,SAAhC;CACCuD,eAAG,CAAH,IAAQ,CAACvD,SAAV,KAAyBuD,GAAG,CAAH,IAAQ,CAACvD,SAAlC;CACA,mBAAOuD,EAAP;CACH,SAXD;;;CAcA/D,0BAAkBqB,SAAlB,CAA4ByC,OAA5B,GAAsC,UAASC,EAAT,EAAa;CAC/C,mBAAO,CACFA,GAAG,CAAH,IAAQzD,GAAR,GAAcC,CADZ,EAEH,CAAEH,KAAKC,EAAL,GAAQ,GAAT,GAAgB,MAAMD,KAAKoC,IAAL,CAAUpC,KAAKqC,GAAL,CAAS,CAACsB,GAAG,CAAH,CAAD,GAASxD,CAAlB,CAAV,CAAvB,IAA0DD,GAFvD,CAAP;CAIH,SALD;;CAOA,eAAON,iBAAP;CAEC,KArMuB,EAAxB;;CAuMA,IAAqE;CACjEiE,sBAAA,GAAiBC,UAAUlE,iBAA3B;CACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CCrMD,IAAMmE,OAAO,IAAInE,iBAAJ,CAAsB;CAClCa,OAAM;CAD4B,CAAtB,CAAb;;CAIA,SAASuD,sBAAT,CAAgCC,CAAhC,EAAmC;CAClCA,GAAEC,QAAF,CAAWC,aAAX,GAA2B,UAAUC,GAAV,EAAeC,GAAf,EAAoB;CAC9C,MAAMC,cAAc,IAAIC,KAAJ,EAApB;CACAD,cAAYE,MAAZ,GAAqB,YAAY;CAChCJ,OAAIK,GAAJ,GAAUJ,GAAV;CACA,GAFD;CAGAC,cAAYG,GAAZ,GAAkBJ,GAAlB;CACA,EAND;CAOA;;CAED,SAASK,YAAT,CAAsBtD,IAAtB,EAA4B;CAC3B,QAAO2C,KAAKnB,GAAL,CAAS,CAAC,CAAC,GAAF,EAAO,CAAC,iBAAR,EAA2B,GAA3B,EAAgC,gBAAhC,CAAT,EAA4DxB,IAA5D,CAAP;CACA;;KAEKuD;;;CACL,sBAAYC,EAAZ,EAAgBpE,OAAhB,EAAyB;CAAA;;CAAA,uHAClBoE,EADkB,EACdpE,OADc;;CAExB,QAAKqE,WAAL,CAAiBrE,OAAjB;;CAFwB;CAIxB;;;;+BAEWA,SAAS;CAAA;;CACpB,QAAKsE,EAAL,CAAQ,gBAAR,EAA0Bd,sBAA1B;CACA,OAAMe,cAAcvE,QAAQwE,KAA5B;CACA,QAAKC,iBAAL,GAAyB,KAAzB;CACA,OAAI,OAAOF,WAAP,KAAuB,QAA3B,EAAqC;CACpCG,UAAMH,WAAN,EAAmBI,IAAnB,CAAwB,oBAAY;CACnC,YAAOC,SAASC,WAAT,EAAP;CACA,KAFD,EAEGF,IAFH,CAEQ,kBAAU;CACjB,YAAKG,OAAL,CAAaC,MAAb;CACA,KAJD,EAIGC,KAJH,CAIS,eAAO;CACf,YAAKC,IAAL,CAAU,eAAV,EAA2B,EAAEC,OAAOC,GAAT,EAA3B;CACA,KAND;CAOA,IARD,MAQO,IAAIZ,uBAAuBa,WAA3B,EAAwC;CAC9C,SAAKN,OAAL,CAAaP,WAAb;CACA,IAFM,MAEA;CACN,SAAKU,IAAL,CAAU,eAAV;CACA;CAED;;CAEE;;;;;;;2BAIKF,QAAQ;CACf,OAAI;CACH;CACA,SAAKM,GAAL,GAAW,IAAIC,OAAOC,GAAP,CAAWC,QAAf,CAAwB,IAAIC,UAAJ,CAAeV,MAAf,CAAxB,CAAX;CACA,SAAKW,KAAL,GAAa,KAAKL,GAAL,CAASM,OAAT,CAAiB,0FAAjB,CAAb;;CAEA;CACA,QAAMC,WAAW,KAAKP,GAAL,CAASM,OAAT,CAAiB,8CAAjB,CAAjB;CACA,QAAIE,YAAJ;;CAEAA,UAAMD,SAASE,WAAT,CAAqB,EAAE,QAAQ,aAAV,EAArB,CAAN;CACA,QAAID,IAAIE,KAAR,EAAe;CAAE,UAAK/F,OAAL,CAAagG,WAAb,GAA2BH,IAAIE,KAA/B;CAAuC;;CAExDF,UAAMD,SAASE,WAAT,CAAqB,EAAE,QAAQ,SAAV,EAArB,CAAN;CACA,QAAID,IAAIE,KAAR,EAAe;CAAE,UAAK/F,OAAL,CAAaiG,OAAb,GAAuBlG,OAAO8F,IAAIE,KAAX,CAAvB;CAA2C;;CAE5DF,UAAMD,SAASE,WAAT,CAAqB,EAAE,QAAQ,SAAV,EAArB,CAAN;CACA,QAAID,IAAIE,KAAR,EAAe;CAAE,UAAK/F,OAAL,CAAakG,OAAb,GAAuBnG,OAAO8F,IAAIE,KAAX,CAAvB;CAA2C;;CAE5DF,UAAMD,SAASE,WAAT,CAAqB,EAAE,QAAQ,QAAV,EAArB,CAAN;CACA,QAAID,IAAIE,KAAJ,IAAaF,IAAIE,KAAJ,KAAc,KAA/B,EAAsC;CACrC,UAAKI,OAAL,GAAe,WAAf;CACA,KAFD,MAEO,IAAIN,IAAIE,KAAJ,IAAaF,IAAIE,KAAJ,KAAc,KAA/B,EAAsC;CAC5C,UAAKI,OAAL,GAAe,WAAf;CACA,KAFM,MAEA;CACN;CACA,UAAKA,OAAL,GAAe,WAAf;CACA;;CAED;CACA;CACA,SAAKlB,IAAL,CAAU,gBAAV;CACA,SAAKR,iBAAL,GAAyB,IAAzB;CACA,SAAK2B,IAAL;CAEA,IAlCD,CAkCE,OAAOC,EAAP,EAAW;CACZ;CACA;CACA;CACA,SAAKpB,IAAL,CAAU,eAAV,EAA2B,EAAEC,OAAOmB,EAAT,EAA3B;CACA;CACD;;;8BAEUhF,GAAGC,GAAGgF,GAAG;CACnB,OAAI,CAAC,KAAKZ,KAAV,EAAiB,OAAOa,SAAP;CACjB,OAAMC,YAAYtC,aAAa,KAAKuC,GAAL,CAASC,OAAT,EAAb,CAAlB;CACA,OAAIF,aAAaA,UAAU3D,IAA3B,EAAiCvB,IAAIkF,UAAU3D,IAAV,GAAiBvB,CAArB;CACjC,OAAMuE,MAAM,KAAKH,KAAL,CAAWI,WAAX,CAAuB;CAClC,UAAMzE,CAD4B;CAElC,UAAMC,CAF4B;CAGlC,UAAMgF;CAH4B,IAAvB,CAAZ;CAKA,OAAI,eAAeT,GAAnB,EAAwB;CACvB,WAAOP,OAAOqB,GAAP,CAAWC,eAAX,CAA2B,IAAIC,IAAJ,CAAS,CAAChB,IAAIiB,SAAL,CAAT,EAA0B,EAAEC,MAAM,WAAR,EAA1B,CAA3B,CAAP;CACA,IAFD,MAEO;CACN,WAAOR,SAAP;CACA;CACD;;;GAxFwBS;;;;;;;;;;;;"}